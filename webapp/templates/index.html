{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block scripts %}

    <script>
        window.addEventListener('load', function () {
            //alert("It's loaded!")
            const main = document.querySelector('main');
            let page_url = new URL(window.location);
            let page = page_url.searchParams.get("page");
            if (!page) {
                page = 1;
            }

            let others = page_url.searchParams.get("others");
            if (!others) {
                let val = document.getElementById("others_check").checked;
                if (val){
                    others="yes"
                } else {
                    others="no"
                }
            }

            checkitems();
            document.getElementById("debug").innerHTML = "In the setup function page=" + page

            sessionStorage.setItem("page", page)
            sessionStorage.setItem("others", others)

            document.getElementById("debug").innerHTML = "debug message " + page + " : " + others
            checkitems();

            //page + " " + others
        })

        function checkitems() {
            let page = Number(sessionStorage.getItem("page"));
            if (page == 1) {
                document.getElementById("newer_button").disabled=true;
            } else {
                document.getElementById("newer_button").disabled=false;
            }
        }
        async function loadPosts(page, others) {
            let myurl = new URL("http://127.0.0.1:5000/post_table");
            myurl.searchParams.append("others", others)
            myurl.searchParams.append("page", page)

            //document.getElementById("debug").innerHTML="middle of load posts"

            let myObject = await fetch(myurl);
            let myText = await myObject.text();
            document.getElementById("post_table").innerHTML = myText
        }

        function othersCheckCallback() {
            const main = document.querySelector('main');
            let val = document.getElementById("others_check").checked;
            let others="no"
            if (val){
                document.getElementById("message").innerHTML = "Displaying posts for all users";
                others = "yes";
            } else {
                document.getElementById("message").innerHTML = "Displaying user posts:";
                others = "no";
            }
            sessionStorage.setItem("others", others);
            let page = sessionStorage.getItem("page");
            document.getElementById("debug").innerHTML = "callback "

            loadPosts(page, others)
            checkitems();
        }
        function newerPosts(){
            let page = Number(sessionStorage.getItem("page"));
            let others = sessionStorage.getItem("others");
            if (page > 1) {
                page = page - 1
            }            document.getElementById("debug").innerHTML="newer posts " + page + ":" + others

            sessionStorage.setItem("page", page);
            loadPosts(page, others)
            checkitems();
        }
        function olderPosts(){
            let page = Number(sessionStorage.getItem("page"));
            let others = sessionStorage.getItem("others");

            page = page + 1
            checkitems();
            document.getElementById("debug").innerHTML="newer posts " + page + ":" + others
            sessionStorage.setItem("page", page);
            //document.getElementById("debug").innerHTML="older posts"

            loadPosts(page, others)
            checkitems();
        }
    </script>
{% endblock %}

{% block app_content %}
    <h1>Hi, {{ current_user.username }}!</h1>
    {% if form %}
        <form action="" method="post">
            {{ form.hidden_tag() }}
            <p>
                {{ form.post.label }}<br>
                {{ form.post(cols=32, rows=4) }}<br>
                {% for error in form.post.errors %}
                    <span class="error">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>{{ form.submit() }}</p>
        </form>
    {% endif %}

    {% if others %}
        <div class="checkbox">
            <label>
                {% if others == "yes" %}
                    <input id="others_check" type="checkbox" onclick="othersCheckCallback()" checked>  Display Other's Posts
                {% else %}
                    <input id="others_check" type="checkbox" onclick="othersCheckCallback()">  Display Other's Posts (blank)
                {% endif %}
            </label>
        </div>
        <p id="message"> Current User = {{ current_user.username }}</p>
        <p id="debug"> This is used for debug messages</p>
    {% endif %}

    <table id="post_table" class="blog">
    {% for post in posts %}

        {% include '_post.html' %}

    {% endfor %}
    </table>
    <br>
    <button class="newold_button" id="newer_button" onclick="newerPosts()">Newer Posts</button>
    <button class="newold_button" id="older_button" onclick="olderPosts()">Older Posts</button>
{% endblock %}

